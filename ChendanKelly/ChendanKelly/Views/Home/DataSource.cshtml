@{
    ViewData["Title"] = "Data Source";
}


<div class="row" id="datasource">

    <div class="col-lg-4" style="padding:5px;">
        <label for="start">文件对应的日期</label>
        <input type="date" id="file-date-picker" name="trip"
               value="2018-07-22"
               min="2018-01-01" max="2018-12-31" />
        <input id="file-picker" type="file" value="选择数据文件上传到系统" />
        <div id="fileGrid" style="height:600px;min-height: 600px;width:100%;margin-top:5px;"
             class="ag-theme-balham"></div>
    </div>

    <div class="col-lg-8" style="padding:5px;">
        <h4 id="file-name"></h4>
        <div id="datasourceGrid" style="height:600px;min-height: 600px;width:100%;margin-top:5px;"
             class="ag-theme-balham"></div>
    </div>

</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.8.0/xlsx.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.8.0/jszip.js"></script>

<script type="text/javascript" charset="utf-8">
    $(document).ready(function () {
        $('#file-date-picker').val(formatDate(new Date()));
    });

    function formatDate(date) {
        var d = new Date(date),
            month = '' + (d.getMonth() + 1),
            day = '' + d.getDate(),
            year = d.getFullYear();

        if (month.length < 2) month = '0' + month;
        if (day.length < 2) day = '0' + day;

        return [year, month, day].join('-');
    }

    var fileGridColumnDefs = [
        {
            headerName: "Date", field: "date", width: 120
        },
        {
            headerName: "FileName", field: "fileName"
        }
    ];
    var fileGridOptions = {
        columnDefs: fileGridColumnDefs,
        rowSelection: 'single',
        onSelectionChanged: onFileGridSelectionChanged
        //rowData: fileRowData
    };
    var fileGrid = document.querySelector('#fileGrid');
    new agGrid.Grid(fileGrid, fileGridOptions);
    agGrid.simpleHttpRequest({ url: '/DataSource/GetAllFiles' }).then(function (data) {
        debugger;
        let newData = [];
        for (let i = 0; i < data.length; i++) {
            data[i].date = data[i].date.slice(0, 10);
            newData.push(data[i]);
        }
        fileGridOptions.api.setRowData(data);
    });

    $("#file-picker").change(function (e) {
        let file = e.currentTarget.files[0];
        var reader = new FileReader();
        reader.onload = function () {
            debugger;
            var fileJson = csvJSON(reader.result);
            let orderId = fileJson[0]["订单编号"] == undefined ? fileJson[0]["\"订单编号\""] : fileJson[0]["订单编号"];
            let baobeiId = fileJson[0]["外部系统编号"] == undefined ? fileJson[0]["\"外部系统编号\""] : fileJson[0]["外部系统编号"];
            if (fileJson.length > 0 && orderId !== undefined && baobeiId === undefined) {
                let newOrders = [];
                for (let i = 0; i < fileJson.length; i++) {
                    let orderId = fileJson[i]["订单编号"] == undefined ? fileJson[i]["\"订单编号\""] : fileJson[i]["订单编号"];
                    let amount = fileJson[i]["总金额"] == undefined ? fileJson[i]["\"总金额\""] : fileJson[i]["总金额"];
                    newOrders.push({
                        orderId: orderId,
                        amount: amount,
                    });
                }
                uploadBaobei($('#file-date-picker')[0].value, newOrders);
            }
            else if (fileJson.length > 0 && orderId !== undefined && baobeiId !== undefined) {
                uploadOrder($('#file-date-picker')[0].value, fileJson);
            }
        };
        reader.readAsText(file, 'utf-8');
    });

    function onFileGridSelectionChanged() {
        var selectedRows = fileGridOptions.api.getSelectedRows();
        alert(JSON.stringify(selectedRows[0]));
    }

    function uploadBaobei(date, jsonValue) {
        debugger;
        fetch('/DataSource/InsertDataToOrderTable', {
            method: 'POST',
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ date, newOrders: jsonValue })
        });
    }

    function uploadOrder(date, jsonValue) {
        debugger;
        fetch('/DataSource/InsertDataToOrderTable', {
            method: 'POST',
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ date, newOrders: jsonValue })
        });
    }

    function csvJSON(csv) {
        var lines = csv.split("\n");
        var result = [];
        var headers = lines[0].split(",");
        for (var i = 1; i < lines.length; i++) {
            var obj = {};
            var currentline = lines[i].split(",");
            for (var j = 0; j < headers.length; j++) {
                obj[headers[j]] = currentline[j];
            }
            result.push(obj);
        }
        return result;
    }
</script>